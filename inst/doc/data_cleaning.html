<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />



<title>EcoCleanR: Overview on Steps for Data cleaning and defining Biogeographic ranges</title>

<script>// Pandoc 2.9 adds attributes on both header and div. We remove the former (to
// be compatible with the behavior of Pandoc < 2.8).
document.addEventListener('DOMContentLoaded', function(e) {
  var hs = document.querySelectorAll("div.section[class*='level'] > :first-child");
  var i, h, a;
  for (i = 0; i < hs.length; i++) {
    h = hs[i];
    if (!/^h[1-6]$/i.test(h.tagName)) continue;  // it should be a header h1-h6
    a = h.attributes;
    while (a.length > 0) h.removeAttribute(a[0].name);
  }
});
</script>

<style type="text/css">
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
</style>



<style type="text/css">
code {
white-space: pre;
}
.sourceCode {
overflow: visible;
}
</style>
<style type="text/css" data-origin="pandoc">
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
{ counter-reset: source-line 0; }
pre.numberSource code > span
{ position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
{ content: counter(source-line);
position: relative; left: -1em; text-align: right; vertical-align: baseline;
border: none; display: inline-block;
-webkit-touch-callout: none; -webkit-user-select: none;
-khtml-user-select: none; -moz-user-select: none;
-ms-user-select: none; user-select: none;
padding: 0 4px; width: 4em;
color: #aaaaaa;
}
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa; padding-left: 4px; }
div.sourceCode
{ }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } 
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.at { color: #7d9029; } 
code span.bn { color: #40a070; } 
code span.bu { color: #008000; } 
code span.cf { color: #007020; font-weight: bold; } 
code span.ch { color: #4070a0; } 
code span.cn { color: #880000; } 
code span.co { color: #60a0b0; font-style: italic; } 
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.do { color: #ba2121; font-style: italic; } 
code span.dt { color: #902000; } 
code span.dv { color: #40a070; } 
code span.er { color: #ff0000; font-weight: bold; } 
code span.ex { } 
code span.fl { color: #40a070; } 
code span.fu { color: #06287e; } 
code span.im { color: #008000; font-weight: bold; } 
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.kw { color: #007020; font-weight: bold; } 
code span.op { color: #666666; } 
code span.ot { color: #007020; } 
code span.pp { color: #bc7a00; } 
code span.sc { color: #4070a0; } 
code span.ss { color: #bb6688; } 
code span.st { color: #4070a0; } 
code span.va { color: #19177c; } 
code span.vs { color: #4070a0; } 
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } 
</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    var j = 0;
    while (j < rules.length) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") {
        j++;
        continue;
      }
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') {
        j++;
        continue;
      }
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>




<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; } 
code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">EcoCleanR: Overview on Steps for Data
cleaning and defining Biogeographic ranges</h1>



<div id="introduction" class="section level2">
<h2>Introduction:</h2>
<p>In this tutorial, we will demonstrate the step-by-step process of
cleaning occurrences and extracting environmental data for the coastal
species Mexacanthina lugubris.</p>
<p>This workflow covers data Cleaning: <br> 1. Remove duplicates<br> 2.
Check bad taxon using WoRMs<br> 3. Improve the coordinate information
utilizing external georeference tools<br> 4. check the coordinate
precision and rounding<br> 5. Flag the records associated with the wrong
ocean/sea and inland<br> 6. Extract the environmental variables<br> 7.
Impute the environmental variables if no assignment from online
resources<br> 8. Identifying outliers<br> 9. Data visualization: <br>
Below is the demonstration of each steps:</p>
<p><strong>Note:</strong> For details on data integration, see the
[<code>data_merging</code>]</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="co"># package loading</span></span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a><span class="fu">library</span>(EcoCleanR)</span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span></code></pre></div>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="co"># provide example species name</span></span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a>species_name <span class="ot">&lt;-</span> <span class="st">&quot;Mexacanthina lugubris&quot;</span></span></code></pre></div>
</div>
<div id="step1-remove-duplicates" class="section level2">
<h2>Step1: Remove duplicates</h2>
<p>Remove duplicates from the merged dataset which is a product after
merging data from various sources</p>
<p><code>ec_rm_duplicate</code> will return an occurrence table
“ecodata” after removing duplicates based on unique catalog numbers,
while retaining abundance counts wherever available.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a>ecodata <span class="ot">&lt;-</span> <span class="fu">ec_rm_duplicate</span>(Mixdb.occ, <span class="at">catalogNumber =</span> <span class="st">&quot;catalogNumber&quot;</span>, <span class="at">abundance =</span> <span class="st">&quot;abundance&quot;</span>)</span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a><span class="fu">str</span>(ecodata[,<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>])</span>
<span id="cb3-3"><a href="#cb3-3" tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4" tabindex="-1"></a><span class="do">### Optional to perform: check the institution code</span></span>
<span id="cb3-5"><a href="#cb3-5" tabindex="-1"></a><span class="co"># inst_counts &lt;- ecodata %&gt;%</span></span>
<span id="cb3-6"><a href="#cb3-6" tabindex="-1"></a><span class="co"># group_by(institutionCode) %&gt;%</span></span>
<span id="cb3-7"><a href="#cb3-7" tabindex="-1"></a><span class="co"># summarise(record_count = n(), .groups = &quot;drop&quot;)</span></span>
<span id="cb3-8"><a href="#cb3-8" tabindex="-1"></a></span>
<span id="cb3-9"><a href="#cb3-9" tabindex="-1"></a><span class="do">### optional to perform..</span></span>
<span id="cb3-10"><a href="#cb3-10" tabindex="-1"></a><span class="co"># ecodata &lt;- ecodata %&gt;%</span></span>
<span id="cb3-11"><a href="#cb3-11" tabindex="-1"></a><span class="co"># filter(is.na(institutionCode) | institutionCode != &quot;NRM&quot;)</span></span></code></pre></div>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a><span class="fu">ec_geographic_map</span>(ecodata,</span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a>  <span class="at">latitude =</span> <span class="st">&quot;decimalLatitude&quot;</span>,</span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a>  <span class="at">longitude =</span> <span class="st">&quot;decimalLongitude&quot;</span></span>
<span id="cb4-4"><a href="#cb4-4" tabindex="-1"></a>)</span></code></pre></div>
</div>
<div id="step2-remove-bad-taxa" class="section level2">
<h2>Step2: Remove bad taxa</h2>
<p>This step helps to check if any wrong taxonomy has fetched from
online datasources by checking if it is an accepted synonym in the WoRMS
(World Register of Marine Species) taxonomy database</p>
<p><code>ec_worms_synonym</code> returns a table named comparison with
two columns: the first column lists the synonyms accepted in the WoRMS
database, and the second column lists the unique species names from
ecodata with the counts of occurrences</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a>comparison <span class="ot">&lt;-</span> <span class="fu">ec_worms_synonym</span>(species_name,</span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a>  ecodata,</span>
<span id="cb5-3"><a href="#cb5-3" tabindex="-1"></a>  <span class="at">scientificName =</span> <span class="st">&quot;scientificName&quot;</span></span>
<span id="cb5-4"><a href="#cb5-4" tabindex="-1"></a>)</span>
<span id="cb5-5"><a href="#cb5-5" tabindex="-1"></a><span class="fu">print</span>(comparison)</span>
<span id="cb5-6"><a href="#cb5-6" tabindex="-1"></a><span class="co"># compare the columns to know if any taxa found that is not a synonym in WoRMS data base, filter bad taxa from ecodata using dplyr::filter()</span></span></code></pre></div>
</div>
<div id="step3-georeferencing-using-external-tool" class="section level2">
<h2>Step3: Georeferencing using external tool</h2>
<p>This step generates a table “data_need_correction” that can
potentially assign georeferences based on the locality and verbatim
locality information in the occurrence table by using furntion
<code>ec_flag_with_locality</code>.</p>
<p>This table can be further used as an input file for the GEOLocate
tool to perform georeferencing. Currently, there is no R code available
to automate this process. This process require manual validation on each
records for the assigned coordinates and uncertainty. (see Scenario B in
the manuscript for this example)</p>
<p>Use <code>ec_merge_coorected_Coordinates</code> to assigned corrected
coordinates - latitude, longitude and coordinte uncertainty, back into
main data table. Pre-saved data file ecodata_corrected.rda, an example
to use as template.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a>ecodata<span class="sc">$</span>flag_check_geolocate <span class="ot">&lt;-</span> <span class="fu">ec_flag_with_locality</span>(ecodata,</span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a>  <span class="at">uncertainty =</span> <span class="st">&quot;coordinateUncertaintyInMeters&quot;</span>,</span>
<span id="cb6-3"><a href="#cb6-3" tabindex="-1"></a>  <span class="at">locality =</span> <span class="st">&quot;locality&quot;</span>,</span>
<span id="cb6-4"><a href="#cb6-4" tabindex="-1"></a>  <span class="at">verbatimLocality =</span> <span class="st">&quot;verbatimLocality&quot;</span></span>
<span id="cb6-5"><a href="#cb6-5" tabindex="-1"></a>)</span>
<span id="cb6-6"><a href="#cb6-6" tabindex="-1"></a><span class="fu">str</span>(ecodata[,<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>])</span>
<span id="cb6-7"><a href="#cb6-7" tabindex="-1"></a>data_need_correction <span class="ot">&lt;-</span> ecodata <span class="sc">%&gt;%</span></span>
<span id="cb6-8"><a href="#cb6-8" tabindex="-1"></a><span class="fu">filter</span>(flag_check_geolocate<span class="sc">!=</span> <span class="dv">1</span>)</span>
<span id="cb6-9"><a href="#cb6-9" tabindex="-1"></a><span class="co">#save the data as local file to insert in GEOLocate web tool</span></span>
<span id="cb6-10"><a href="#cb6-10" tabindex="-1"></a><span class="co">#write.csv(data_need_correction, &quot;data_check_geolocate.csv&quot;)</span></span>
<span id="cb6-11"><a href="#cb6-11" tabindex="-1"></a></span>
<span id="cb6-12"><a href="#cb6-12" tabindex="-1"></a><span class="co">#Load back the corrected coordinate file extracted from GEOLocate </span></span>
<span id="cb6-13"><a href="#cb6-13" tabindex="-1"></a><span class="co">#ecodata_corrected &lt;- read.csv(&quot;M lugubris_corrected_geolocate.csv&quot;)</span></span>
<span id="cb6-14"><a href="#cb6-14" tabindex="-1"></a></span>
<span id="cb6-15"><a href="#cb6-15" tabindex="-1"></a><span class="do">### Merged records with improved georeference:</span></span>
<span id="cb6-16"><a href="#cb6-16" tabindex="-1"></a>ecodata <span class="ot">&lt;-</span> <span class="fu">ec_merge_corrected_coordinates</span>(</span>
<span id="cb6-17"><a href="#cb6-17" tabindex="-1"></a>  ecodata_corrected, </span>
<span id="cb6-18"><a href="#cb6-18" tabindex="-1"></a>  ecodata, </span>
<span id="cb6-19"><a href="#cb6-19" tabindex="-1"></a>  <span class="at">latitude =</span> <span class="st">&quot;decimalLatitude&quot;</span>, </span>
<span id="cb6-20"><a href="#cb6-20" tabindex="-1"></a>  <span class="at">longitude =</span> <span class="st">&quot;decimalLongitude&quot;</span>,       </span>
<span id="cb6-21"><a href="#cb6-21" tabindex="-1"></a>  <span class="at">uncertainty_col =</span> <span class="st">&quot;coordinateUncertaintyInMeters&quot;</span></span>
<span id="cb6-22"><a href="#cb6-22" tabindex="-1"></a>)</span>
<span id="cb6-23"><a href="#cb6-23" tabindex="-1"></a><span class="fu">str</span>(ecodata[,<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>]) </span>
<span id="cb6-24"><a href="#cb6-24" tabindex="-1"></a></span>
<span id="cb6-25"><a href="#cb6-25" tabindex="-1"></a><span class="do">### Plot the map to visualize the datapoints</span></span>
<span id="cb6-26"><a href="#cb6-26" tabindex="-1"></a><span class="fu">ec_geographic_map</span>(ecodata, <span class="at">latitude =</span> <span class="st">&quot;decimalLatitude&quot;</span>, <span class="at">longitude =</span> <span class="st">&quot;decimalLongitude&quot;</span>)</span></code></pre></div>
</div>
<div id="step4-extreme-high-uncertainty" class="section level2">
<h2>Step4: Extreme high uncertainty</h2>
<p><code>ec_filter_by_uncertainty</code> function can be used in all
scenarios (see manuscript) to help remove extremely high uncertainty
from the remaining data.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a>ecodata_cl <span class="ot">&lt;-</span> <span class="fu">ec_filter_by_uncertainty</span>(ecodata,</span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a>  <span class="at">uncertainty_col =</span> <span class="st">&quot;coordinateUncertaintyInMeters&quot;</span>,</span>
<span id="cb7-3"><a href="#cb7-3" tabindex="-1"></a>  <span class="at">percentile =</span> <span class="fl">0.95</span>,</span>
<span id="cb7-4"><a href="#cb7-4" tabindex="-1"></a>  <span class="at">ask =</span> <span class="cn">FALSE</span>,</span>
<span id="cb7-5"><a href="#cb7-5" tabindex="-1"></a>  <span class="at">latitude =</span> <span class="st">&quot;decimalLatitude&quot;</span>,</span>
<span id="cb7-6"><a href="#cb7-6" tabindex="-1"></a>  <span class="at">longitude =</span> <span class="st">&quot;decimalLongitude&quot;</span></span>
<span id="cb7-7"><a href="#cb7-7" tabindex="-1"></a>)</span>
<span id="cb7-8"><a href="#cb7-8" tabindex="-1"></a><span class="fu">str</span>(ecodata_cl[, <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>])</span>
<span id="cb7-9"><a href="#cb7-9" tabindex="-1"></a><span class="do">### plot the map</span></span>
<span id="cb7-10"><a href="#cb7-10" tabindex="-1"></a><span class="fu">ec_geographic_map</span>(ecodata_cl,</span>
<span id="cb7-11"><a href="#cb7-11" tabindex="-1"></a>  <span class="at">latitude =</span> <span class="st">&quot;decimalLatitude&quot;</span>,</span>
<span id="cb7-12"><a href="#cb7-12" tabindex="-1"></a>  <span class="at">longitude =</span> <span class="st">&quot;decimalLongitude&quot;</span></span>
<span id="cb7-13"><a href="#cb7-13" tabindex="-1"></a>)</span></code></pre></div>
</div>
<div id="step5-coordinate-precision-and-rounding" class="section level2">
<h2>Step5: Coordinate precision and rounding</h2>
<p><code>ec_flag_precision</code> checks the precision of the
coordinates. This function flags the records based on two checkpoints:
1) flag both coordinates independently if they have &lt;2 decimal
points; 2) check if any rounding to the nearest 0.5° in either of those
coordinates.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a>ecodata_cl<span class="sc">$</span>flag_precision <span class="ot">&lt;-</span> <span class="fu">ec_flag_precision</span>(ecodata_cl,</span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a>  <span class="at">latitude =</span> <span class="st">&quot;decimalLatitude&quot;</span>,</span>
<span id="cb8-3"><a href="#cb8-3" tabindex="-1"></a>  <span class="at">longitude =</span> <span class="st">&quot;decimalLongitude&quot;</span></span>
<span id="cb8-4"><a href="#cb8-4" tabindex="-1"></a>)</span>
<span id="cb8-5"><a href="#cb8-5" tabindex="-1"></a></span>
<span id="cb8-6"><a href="#cb8-6" tabindex="-1"></a><span class="co"># filter the flag - flag_cordinate_precision</span></span>
<span id="cb8-7"><a href="#cb8-7" tabindex="-1"></a>ecodata_cl <span class="ot">&lt;-</span> ecodata_cl <span class="sc">%&gt;%</span></span>
<span id="cb8-8"><a href="#cb8-8" tabindex="-1"></a>  <span class="fu">filter</span>(flag_precision <span class="sc">!=</span> <span class="dv">1</span>)</span>
<span id="cb8-9"><a href="#cb8-9" tabindex="-1"></a><span class="fu">str</span>(ecodata_cl[<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>])</span></code></pre></div>
</div>
<div id="step6-records-tagged-to-wrong-oceansea" class="section level2">
<h2>Step6: Records tagged to wrong ocean/sea</h2>
<p><code>ec_flag_non_region</code> function helps identify records that
are incorrectly tagged under the wrong ocean or sea. Expert knowledge is
required to recognize when a species is unlikely to occur in certain
ocean regions. For example, Mexacanthina lugubris is an Eastern Pacific
species; therefore, any occurrences reported from the Atlantic Ocean
would be flagged after running this function. <br> Variables “direction”
accepts input as “east” or “west”, and variable “ocean” accepts input
“atlantic” or “pacific”. <br> If given species lives globally, this
cleaning step would not be needed.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a><span class="co"># This is a heavy processing step, won’t execute during vignette building.</span></span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a>direction <span class="ot">&lt;-</span> <span class="st">&quot;east&quot;</span></span>
<span id="cb9-3"><a href="#cb9-3" tabindex="-1"></a>buffer <span class="ot">&lt;-</span> <span class="dv">25000</span></span>
<span id="cb9-4"><a href="#cb9-4" tabindex="-1"></a>ocean <span class="ot">&lt;-</span> <span class="st">&quot;pacific&quot;</span></span>
<span id="cb9-5"><a href="#cb9-5" tabindex="-1"></a>ecodata_cl<span class="sc">$</span>flag_non_region <span class="ot">&lt;-</span> <span class="fu">ec_flag_non_region</span>(direction,</span>
<span id="cb9-6"><a href="#cb9-6" tabindex="-1"></a>  ocean,</span>
<span id="cb9-7"><a href="#cb9-7" tabindex="-1"></a>  buffer,</span>
<span id="cb9-8"><a href="#cb9-8" tabindex="-1"></a>  ecodata_cl,</span>
<span id="cb9-9"><a href="#cb9-9" tabindex="-1"></a>  <span class="at">latitude =</span> <span class="st">&quot;decimalLatitude&quot;</span>,</span>
<span id="cb9-10"><a href="#cb9-10" tabindex="-1"></a>  <span class="at">longitude =</span> <span class="st">&quot;decimalLongitude&quot;</span></span>
<span id="cb9-11"><a href="#cb9-11" tabindex="-1"></a>)</span>
<span id="cb9-12"><a href="#cb9-12" tabindex="-1"></a><span class="fu">str</span>(ecodata_cl[, <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>])</span>
<span id="cb9-13"><a href="#cb9-13" tabindex="-1"></a><span class="co"># filter flagged records</span></span>
<span id="cb9-14"><a href="#cb9-14" tabindex="-1"></a>ecodata_cl <span class="ot">&lt;-</span> ecodata_cl <span class="sc">%&gt;%</span></span>
<span id="cb9-15"><a href="#cb9-15" tabindex="-1"></a>  <span class="fu">filter</span>(flag_non_region <span class="sc">!=</span> <span class="dv">1</span>)</span>
<span id="cb9-16"><a href="#cb9-16" tabindex="-1"></a><span class="do">### map view to see accepted records</span></span>
<span id="cb9-17"><a href="#cb9-17" tabindex="-1"></a><span class="fu">ec_geographic_map</span>(ecodata_cl,</span>
<span id="cb9-18"><a href="#cb9-18" tabindex="-1"></a>  <span class="at">latitude =</span> <span class="st">&quot;decimalLatitude&quot;</span>,</span>
<span id="cb9-19"><a href="#cb9-19" tabindex="-1"></a>  <span class="at">longitude =</span> <span class="st">&quot;decimalLongitude&quot;</span></span>
<span id="cb9-20"><a href="#cb9-20" tabindex="-1"></a>)</span></code></pre></div>
</div>
<div id="step7-extract-the-environmental-data" class="section level2">
<h2>Step7: Extract the environmental data</h2>
<p><code>ec_extract_env_layers</code> This function extracts
environmental data for occurrence points using their associated
coordinates. It is designed with the ‘sdmpredictors’ package to extract
layers from sources such as Bio-ORACLE, MARSPEC, and WorldClim.</p>
<p><code>ec_impute_env_values</code> imputes environmental data for
coordinates lacking values in the environmental data sources. This will
provide average value of existing data within input radius.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a><span class="co"># This is a heavy processing step, won’t execute during vignette building.</span></span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a><span class="co"># get the unique combination of coordiantes</span></span>
<span id="cb10-3"><a href="#cb10-3" tabindex="-1"></a>ecodata_unique <span class="ot">&lt;-</span> ecodata_cl[, <span class="fu">c</span>(<span class="st">&quot;decimalLatitude&quot;</span>, <span class="st">&quot;decimalLongitude&quot;</span>)]</span>
<span id="cb10-4"><a href="#cb10-4" tabindex="-1"></a>ecodata_unique <span class="ot">&lt;-</span> base<span class="sc">::</span><span class="fu">unique</span>(ecodata_unique)</span>
<span id="cb10-5"><a href="#cb10-5" tabindex="-1"></a><span class="co"># It is recommended to check what layers available in sdm_predictors and correct name.</span></span>
<span id="cb10-6"><a href="#cb10-6" tabindex="-1"></a><span class="co"># available_layers &lt;- list_layers() # returns something like c(&quot;BO_sstmean&quot;, &quot;BO_sstmax&quot;, ...)</span></span>
<span id="cb10-7"><a href="#cb10-7" tabindex="-1"></a><span class="co"># provide layers as input to env_layers variable</span></span>
<span id="cb10-8"><a href="#cb10-8" tabindex="-1"></a>env_layers <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;BO_sstmean&quot;</span>, <span class="st">&quot;BO_sstmin&quot;</span>, <span class="st">&quot;BO_sstmax&quot;</span>)</span>
<span id="cb10-9"><a href="#cb10-9" tabindex="-1"></a></span>
<span id="cb10-10"><a href="#cb10-10" tabindex="-1"></a><span class="do">### extraction env layers</span></span>
<span id="cb10-11"><a href="#cb10-11" tabindex="-1"></a>ecodata_unique <span class="ot">&lt;-</span> <span class="fu">ec_extract_env_layers</span>(ecodata_unique,</span>
<span id="cb10-12"><a href="#cb10-12" tabindex="-1"></a>  <span class="at">env_layers =</span> env_layers,</span>
<span id="cb10-13"><a href="#cb10-13" tabindex="-1"></a>  <span class="at">latitude =</span> <span class="st">&quot;decimalLatitude&quot;</span>,</span>
<span id="cb10-14"><a href="#cb10-14" tabindex="-1"></a>  <span class="at">longitude =</span> <span class="st">&quot;decimalLongitude&quot;</span></span>
<span id="cb10-15"><a href="#cb10-15" tabindex="-1"></a>)</span>
<span id="cb10-16"><a href="#cb10-16" tabindex="-1"></a><span class="co"># A warning message if layers are in saved in cache.</span></span>
<span id="cb10-17"><a href="#cb10-17" tabindex="-1"></a></span>
<span id="cb10-18"><a href="#cb10-18" tabindex="-1"></a><span class="do">### impute env var values those were missing after extraction</span></span>
<span id="cb10-19"><a href="#cb10-19" tabindex="-1"></a>ecodata_unique <span class="ot">&lt;-</span> <span class="fu">ec_impute_env_values</span>(</span>
<span id="cb10-20"><a href="#cb10-20" tabindex="-1"></a>  ecodata_unique,</span>
<span id="cb10-21"><a href="#cb10-21" tabindex="-1"></a>  <span class="at">latitude =</span> <span class="st">&quot;decimalLatitude&quot;</span>,</span>
<span id="cb10-22"><a href="#cb10-22" tabindex="-1"></a>  <span class="at">longitude =</span> <span class="st">&quot;decimalLongitude&quot;</span>,</span>
<span id="cb10-23"><a href="#cb10-23" tabindex="-1"></a>  <span class="at">radius_km =</span> <span class="dv">10</span>,</span>
<span id="cb10-24"><a href="#cb10-24" tabindex="-1"></a>  <span class="at">iter =</span> <span class="dv">3</span></span>
<span id="cb10-25"><a href="#cb10-25" tabindex="-1"></a>)</span>
<span id="cb10-26"><a href="#cb10-26" tabindex="-1"></a></span>
<span id="cb10-27"><a href="#cb10-27" tabindex="-1"></a><span class="do">### omit the coordinate which couldn&#39;t get any env values after imputation</span></span>
<span id="cb10-28"><a href="#cb10-28" tabindex="-1"></a>ecodata_unique <span class="ot">&lt;-</span> <span class="fu">na.omit</span>(ecodata_unique)</span></code></pre></div>
</div>
<div id="step8-identify-outliers" class="section level2">
<h2>Step8: Identify outliers</h2>
<p>ec_flag_outlier function helps to identify outliers based on both
spatial (coordinates) and non-spatial (environmental) attributes. (see
manuscript for more detail about this function)</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a><span class="co"># This is a heavy processing step, won’t execute during vignette building.</span></span>
<span id="cb11-2"><a href="#cb11-2" tabindex="-1"></a><span class="co"># Instead of executing it here, we will use a pre-saved cleaned file.</span></span>
<span id="cb11-3"><a href="#cb11-3" tabindex="-1"></a>ecodata_unique<span class="sc">$</span>flag_outliers <span class="ot">&lt;-</span> <span class="fu">ec_flag_outlier</span>(ecodata_unique,</span>
<span id="cb11-4"><a href="#cb11-4" tabindex="-1"></a>  <span class="at">latitude =</span> <span class="st">&quot;decimalLatitude&quot;</span>,</span>
<span id="cb11-5"><a href="#cb11-5" tabindex="-1"></a>  <span class="at">longitude =</span> <span class="st">&quot;decimalLongitude&quot;</span>,</span>
<span id="cb11-6"><a href="#cb11-6" tabindex="-1"></a>  env_layers,</span>
<span id="cb11-7"><a href="#cb11-7" tabindex="-1"></a>  <span class="at">itr =</span> <span class="dv">50</span>,</span>
<span id="cb11-8"><a href="#cb11-8" tabindex="-1"></a>  <span class="at">k =</span> <span class="dv">3</span>,</span>
<span id="cb11-9"><a href="#cb11-9" tabindex="-1"></a>  <span class="at">geo_quantile =</span> <span class="fl">0.99</span>,</span>
<span id="cb11-10"><a href="#cb11-10" tabindex="-1"></a>  <span class="at">maha_quantile =</span> <span class="fl">0.99</span></span>
<span id="cb11-11"><a href="#cb11-11" tabindex="-1"></a>)<span class="sc">$</span>outlier</span>
<span id="cb11-12"><a href="#cb11-12" tabindex="-1"></a></span>
<span id="cb11-13"><a href="#cb11-13" tabindex="-1"></a><span class="do">### these unique combinations of coordiantes, environmental variables and outliers will be mergeed to main ecodata_cl file</span></span>
<span id="cb11-14"><a href="#cb11-14" tabindex="-1"></a>ecodata_cl <span class="ot">&lt;-</span> ecodata_cl <span class="sc">%&gt;%</span></span>
<span id="cb11-15"><a href="#cb11-15" tabindex="-1"></a>  <span class="fu">left_join</span>(ecodata_unique[, <span class="fu">c</span>(<span class="st">&quot;decimalLatitude&quot;</span>, <span class="st">&quot;decimalLongitude&quot;</span>, <span class="st">&quot;flag_outliers&quot;</span>, env_layers)],</span>
<span id="cb11-16"><a href="#cb11-16" tabindex="-1"></a>    <span class="at">by =</span> <span class="fu">c</span>(<span class="st">&quot;decimalLatitude&quot;</span>, <span class="st">&quot;decimalLongitude&quot;</span>)</span>
<span id="cb11-17"><a href="#cb11-17" tabindex="-1"></a>  )</span></code></pre></div>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a><span class="co"># pre-saved file ecodata_with_outliers instead of using ecodata_cl</span></span>
<span id="cb12-2"><a href="#cb12-2" tabindex="-1"></a><span class="do">### map view to see records with outlier probability</span></span>
<span id="cb12-3"><a href="#cb12-3" tabindex="-1"></a><span class="fu">ec_geographic_map_w_flag</span>(ecodata_with_outliers,</span>
<span id="cb12-4"><a href="#cb12-4" tabindex="-1"></a>  <span class="at">flag_column =</span> <span class="st">&quot;outliers&quot;</span>,</span>
<span id="cb12-5"><a href="#cb12-5" tabindex="-1"></a>  <span class="at">latitude =</span> <span class="st">&quot;decimalLatitude&quot;</span>,</span>
<span id="cb12-6"><a href="#cb12-6" tabindex="-1"></a>  <span class="at">longitude =</span> <span class="st">&quot;decimalLongitude&quot;</span></span>
<span id="cb12-7"><a href="#cb12-7" tabindex="-1"></a>)</span></code></pre></div>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a><span class="do">### Filter outliers those have higher outlier probability &gt;0.90, 0.95 etc.</span></span>
<span id="cb13-2"><a href="#cb13-2" tabindex="-1"></a>ecodata_cleaned <span class="ot">&lt;-</span> ecodata_cl <span class="sc">%&gt;%</span></span>
<span id="cb13-3"><a href="#cb13-3" tabindex="-1"></a>  <span class="fu">filter</span>(flag_outliers <span class="sc">&lt;</span> <span class="fl">0.95</span>)</span></code></pre></div>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" tabindex="-1"></a><span class="do">### mapview to visualize accepted data</span></span>
<span id="cb14-2"><a href="#cb14-2" tabindex="-1"></a><span class="fu">ec_geographic_map</span>(ecodata_cleaned,</span>
<span id="cb14-3"><a href="#cb14-3" tabindex="-1"></a>  <span class="at">latitude =</span> <span class="st">&quot;decimalLatitude&quot;</span>,</span>
<span id="cb14-4"><a href="#cb14-4" tabindex="-1"></a>  <span class="at">longitude =</span> <span class="st">&quot;decimalLongitude&quot;</span></span>
<span id="cb14-5"><a href="#cb14-5" tabindex="-1"></a>)</span></code></pre></div>
</div>
<div id="step9-display-final-accepted-biogeographic-range" class="section level2">
<h2>Step9: Display final accepted biogeographic range</h2>
<p><code>ec_var_summary</code> generates a summary table of accepted
occurrences after data cleaning, showing mean, minimum, and maximum
values for spatial and non-spatial attributes.</p>
<p><code>ec_plot_var_range</code> shows a plot of accepted ranges.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" tabindex="-1"></a>env_layers <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;BO_sstmean&quot;</span>, <span class="st">&quot;BO_sstmax&quot;</span>, <span class="st">&quot;BO_sstmin&quot;</span>)</span>
<span id="cb15-2"><a href="#cb15-2" tabindex="-1"></a><span class="fu">data</span>(<span class="st">&quot;ecodata_cleaned&quot;</span>)</span>
<span id="cb15-3"><a href="#cb15-3" tabindex="-1"></a>summary_table <span class="ot">&lt;-</span> <span class="fu">ec_var_summary</span>(ecodata_cleaned,</span>
<span id="cb15-4"><a href="#cb15-4" tabindex="-1"></a>  <span class="at">latitude =</span> <span class="st">&quot;decimalLatitude&quot;</span>,</span>
<span id="cb15-5"><a href="#cb15-5" tabindex="-1"></a>  <span class="at">longitude =</span> <span class="st">&quot;decimalLongitude&quot;</span>,</span>
<span id="cb15-6"><a href="#cb15-6" tabindex="-1"></a>  env_layers</span>
<span id="cb15-7"><a href="#cb15-7" tabindex="-1"></a>)</span>
<span id="cb15-8"><a href="#cb15-8" tabindex="-1"></a><span class="fu">head</span>(summary_table)</span>
<span id="cb15-9"><a href="#cb15-9" tabindex="-1"></a></span>
<span id="cb15-10"><a href="#cb15-10" tabindex="-1"></a><span class="fu">ec_plot_var_range</span>(ecodata_with_outliers,</span>
<span id="cb15-11"><a href="#cb15-11" tabindex="-1"></a>  <span class="at">summary_df =</span> summary_table,</span>
<span id="cb15-12"><a href="#cb15-12" tabindex="-1"></a>  <span class="at">latitude =</span> <span class="st">&quot;decimalLatitude&quot;</span>,</span>
<span id="cb15-13"><a href="#cb15-13" tabindex="-1"></a>  <span class="at">longitude =</span> <span class="st">&quot;decimalLongitude&quot;</span>,</span>
<span id="cb15-14"><a href="#cb15-14" tabindex="-1"></a>  <span class="at">env_layers =</span> env_layers</span>
<span id="cb15-15"><a href="#cb15-15" tabindex="-1"></a>)</span></code></pre></div>
<p>Further documents:<br></p>
<p>*see data merging vignette: [<code>data_merging</code>]<br></p>
<p>*see citation guidelines for the downloaded files from gbif, obis,
idigbio and InvertEbase vignettes/article/cite_data.rmd</p>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
